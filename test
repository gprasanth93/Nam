const Transport = require('winston-transport');
const fetch = require('node-fetch');

class HttpTransportWithQueue extends Transport {
  constructor(opts) {
    super(opts);
    this.url = opts.url;
    this.queue = [];
    this.isSending = false;
  }

  log(info, callback) {
    setImmediate(() => {
      this.emit('logged', info);
    });

    this.queue.push(info);
    this.processQueue();

    callback();
  }

  async processQueue() {
    if (this.isSending || this.queue.length === 0) {
      return;
    }

    this.isSending = true;
    while (this.queue.length > 0) {
      const log = this.queue[0];
      try {
        const response = await fetch(this.url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(log),
        });
        if (response.ok) {
          this.queue.shift(); // Remove log from queue if successfully sent
        } else {
          console.error('Failed to send log, status:', response.status);
          break; // Exit loop to retry later
        }
      } catch (error) {
        console.error('Error sending log:', error);
        break; // Exit loop to retry later
      }
    }
    this.isSending = false;
  }
}

module.exports = HttpTransportWithQueue;
