document.addEventListener('DOMContentLoaded', () => {
    const consoleElement = document.getElementById('console');
    const hostnameColors = {};
    const colorPalette = ['cyan', 'magenta', 'yellow', 'orange', 'lightgreen', 'lightblue', 'violet'];

    function getRandomColor() {
        return colorPalette[Math.floor(Math.random() * colorPalette.length)];
    }

    function createConsoleItem(item) {
        if (!hostnameColors[item.hostname]) {
            hostnameColors[item.hostname] = getRandomColor();
        }

        const itemElement = document.createElement('div');
        itemElement.classList.add('console-item', `color-${item.level}`);

        const timestampElement = document.createElement('span');
        timestampElement.textContent = `${item.timestamp} `;

        const hostnameElement = document.createElement('span');
        hostnameElement.style.color = hostnameColors[item.hostname];
        hostnameElement.textContent = `[${item.hostname}] `;

        const messageElement = document.createElement('span');
        messageElement.textContent = `${item.label.toUpperCase()}: ${item.message}`;

        itemElement.appendChild(timestampElement);
        itemElement.appendChild(hostnameElement);
        itemElement.appendChild(messageElement);

        return itemElement;
    }

    function fetchAndDisplayData() {
        fetch('/api/logs')  // Replace with your actual API endpoint
            .then(response => response.json())
            .then(data => {
                consoleElement.innerHTML = '';  // Clear previous data

                // Sort the data based on timestamp
                data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                data.forEach(item => {
                    const itemElement = createConsoleItem(item);
                    consoleElement.appendChild(itemElement);
                });

                // Scroll to bottom
                consoleElement.scrollTop = consoleElement.scrollHeight;
            })
            .catch(error => console.error('Error fetching data:', error));
    }

    // Fetch data initially
    fetchAndDisplayData();

    // Connect to SSE stream
    const eventSource = new EventSource('/api/logs/stream');  // Replace with your SSE endpoint

    eventSource.onmessage = (event) => {
        const newItem = JSON.parse(event.data);
        const itemElement = createConsoleItem(newItem);

        const shouldScroll = consoleElement.scrollTop + consoleElement.clientHeight === consoleElement.scrollHeight;
        consoleElement.appendChild(itemElement);

        if (shouldScroll) {
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }
    };

    eventSource.onerror = (error) => {
        console.error('Error with SSE connection:', error);
    };
});
